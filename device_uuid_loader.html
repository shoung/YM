<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>裝置識別碼載入器</title>
    <style>
        body { font-family: sans-serif; margin: 20px; text-align: center; }
        p { margin-bottom: 10px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; margin-top: 20px; } /* 新增警語樣式 */
    </style>
</head>
<body>
    <p>正在載入裝置識別碼...</p>
    <p id="statusMessage"></p>
    <p id="manualCloseWarning" class="warning" style="display: none;">如果本網頁沒有自動關閉，請手動關閉分頁後，繼續進行作業。</p> <script>
        const UUID_KEY = 'fm_device_uuid'; // Local Storage Key
        const MANUAL_CLOSE_TIMEOUT = 3000; // 3 秒後顯示手動關閉警語

        // Function to generate a UUID (same as before)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Function to get or create the device UUID (same as before)
        function getOrCreateDeviceUUID() {
            let uuid = localStorage.getItem(UUID_KEY);
            if (!uuid) {
                uuid = generateUUID();
                localStorage.setItem(UUID_KEY, uuid);
            }
            return uuid;
        }

        // Function to send UUID back to FileMaker and attempt to close the window
        function sendUUIDToFileMakerAndAttemptClose(uuid) {
            const statusMessage = document.getElementById('statusMessage');
            const manualCloseWarning = document.getElementById('manualCloseWarning');

            try {
                // *** IMPORTANT: This 'fmp' URL scheme is for FileMaker Pro/Go.
                // For WebDirect, direct window.opener or fmp:// callback from a popup is problematic.
                // We are proceeding with the assumption that this page is opened via FileMaker's Open URL.

                // If using Open URL, the primary goal here is to ensure UUID is set in localStorage
                // and then *attempt* to close. FileMaker will then pick it up via a separate mechanism (e.g., polling Web Viewer).

                // In the context of FileMaker WebDirect's Web Viewer (our primary troubleshooting path):
                // This 'if' block would be executed.
                if (typeof FileMaker !== 'undefined' && FileMaker.PerformScript) {
                    FileMaker.PerformScript('接收裝置UUID', uuid); // 呼叫 FileMaker 腳本
                    statusMessage.className = 'success';
                    statusMessage.textContent = '裝置識別碼已傳送至 FileMaker。';
                    // 在 Web Viewer 內通常不需要自動關閉，但如果它被彈出，可能需要。
                    // 這裡先不加 window.close()，因為是在 Web Viewer 內。
                    // 如果是用 Open URL 開啟，則下面的 else 區塊會處理關閉嘗試。
                } else {
                    // This block runs if not in a recognized FileMaker environment (e.g., direct browser open, or Open URL scenario)
                    console.log('FileMaker.PerformScript is not available. Device UUID:', uuid);
                    statusMessage.className = 'error'; // 或 'info' 取決於您希望的視覺效果
                    statusMessage.textContent = '裝置識別碼已產生並儲存。'; // 假設主要目的是設置 UUID，而非回傳
                    
                    // 嘗試自動關閉視窗 (主要針對 Open URL 開啟的彈出視窗)
                    setTimeout(() => {
                        try {
                            window.close(); // 嘗試關閉視窗
                        } catch (e) {
                            console.warn("自動關閉視窗失敗:", e);
                            // 如果自動關閉失敗，顯示手動關閉警語
                            manualCloseWarning.style.display = 'block';
                        }
                    }, 500); // 給一點時間處理和顯示訊息

                    // 即使自動關閉成功，如果使用者在關閉前看到，也可顯示警語
                    setTimeout(() => {
                        if (!window.closed) { // 檢查視窗是否已經關閉
                            manualCloseWarning.style.display = 'block';
                        }
                    }, MANUAL_CLOSE_TIMEOUT); // 延遲顯示警語
                }

            } catch (e) {
                statusMessage.className = 'error';
                statusMessage.textContent = '處理裝置識別碼時發生錯誤: ' + e.message + ' UUID: ' + uuid;
                console.error('處理裝置識別碼時發生錯誤:', e);
                manualCloseWarning.style.display = 'block'; // 發生錯誤也顯示警語
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const currentDeviceUUID = getOrCreateDeviceUUID();
            document.body.innerHTML = `
                <p>裝置識別碼已準備好。</p>
                <p>UUID: <span style="font-weight: bold;">${currentDeviceUUID}</span></p>
                <p id="statusMessage">正在嘗試處理裝置識別碼...</p>
                <p id="manualCloseWarning" class="warning" style="display: none;">如果本網頁沒有自動關閉，請手動關閉分頁後，繼續進行作業。</p>
            `;
            // 重新取得元素，因為 innerHTML 改變了它們
            const updatedStatusMessage = document.getElementById('statusMessage');
            const updatedManualCloseWarning = document.getElementById('manualCloseWarning');

            // 確保訊息和警語在執行前被正確設置
            updatedStatusMessage.textContent = '正在嘗試處理裝置識別碼...'; // 初始狀態訊息

            sendUUIDToFileMakerAndAttemptClose(currentDeviceUUID);
        });
    </script>
</body>
</html>
